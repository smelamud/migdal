{{!
1. Если поле something отсутствует из-за того, что редактор данного типа
   сообщения его не предусматривает, оно должно присутствовать в виде hidden,
   поскольку может присутствовать в других тенях этого же сообщения. В
   противном случае actions/postingmod.php затрет это поле.
2. Все поля должны включаться, если $full!=0.
}}

{{!
<int name='noguests'>

<int name='relogin'>
<string name='login'>
<int name='remember'>

<string name='comment1'>
<int name='small_image'>
<int name='small_image_x'>
<int name='small_image_y'>
<string name='small_image_format'>
<int name='large_image'>
<int name='large_image_x'>
<int name='large_image_y'>
<int name='large_image_size'>
<string name='large_image_format'>
<string name='large_image_filename'>

<posting_obj id='$editid' grp='$grp' topic_id='$parent_id' up='$up'
             index1='$index1' fields!='*SELECT_GENERAL|*SELECT_LARGE_BODY'>}}

{{#*inline "formTextFormat"}} {{! params: title,comment,name,format,mandatory }}
    {{#formSelect title=title comment=comment name=name mandatory=mandatory}}
        {{#each const.textFormats}}
            {{#if user}}
                {{formOption title=title value=value selectedValue=format}}
            {{else}}
                {{#if postingForm.full}}
                    {{formOption title=title value=value selectedValue=format}}
                {{/if}}
            {{/if}}
        {{/each}}
    {{/formSelect}}
{{/inline}}

{{#*inline "formDateTime"}} {{! params: title,comment,name,date,time,mandatory }}
    {{#formLine title=title name=name mandatory=mandatory comment=comment}}
        {{#assign "editName"}}{{name}}Date{{/assign}}
        {{edit name=editName value=date size="16" maxlength="16" class="datepicker"}}
        {{#assign "editName"}}{{name}}Time{{/assign}}
        {{edit name=editName value=time size="12" maxlength="12"}}
    {{/formLine}}
{{/inline}}

{{#*inline "editorLine"}} {{! params: editor,visible }}
    {{#if editor.section}}
        {{formSection title=editor.title}}
    {{/if}}

    {{#ifeq editor.field "priority"}}
        {{#if visible}}
            {{formEdit title=editor.title comment=editor.comment name="priority" value=postingForm.priority
                       size="4" maxlength="3" mandatory=editor.mandatory}}
        {{else}}
            {{hidden name="priority" value=postingForm.priority}}
        {{/if}}
    {{/ifeq}}

    {{#ifeq editor.field "topic"}}
        {{#if visible}}
            {{formTopicSelect title=editor.title comment=editor.comment name="parentId" value=postingForm.parentId
                              mandatory=editor.mandatory list=topicNames}}
        {{else}}
            {{hidden name="parentId" value=postingForm.parentId}}
        {{/if}}
    {{/ifeq}}

    {{#ifeq editor.field "ident"}}
        {{#if visible}}
            {{formEdit title=editor.title comment=editor.comment name="ident" value=postingForm.ident size="20"
                       maxlength="75" mandatory=editor.mandatory}}
        {{else}}
            {{hidden name="ident" value=postingForm.ident}}
        {{/if}}
    {{/ifeq}}

    {{#ifeq editor.field "subject"}}
        {{#if visible}}
            {{formEdit title=editor.title comment=editor.comment value=postingForm.subject name="subject" size="70"
                       maxlength="250" mandatory=editor.mandatory}}
        {{else}}
            {{hidden name="subject" value=postingForm.subject}}
        {{/if}}
    {{/ifeq}}

    {{#ifeq editor.field "author"}}
        {{#if visible}}
            {{!<error id='*EP_AUTHOR_ABSENT' text#='$=editor.Title не указан'>}}
            {{formEdit title=editor.title comment=editor.comment value=postingForm.author name="author" size="52"
                       maxlength="250" mandatory=editor.mandatory xmlid=xmlid}}
        {{else}}
            {{hidden name="author" value=postingForm.author}}
        {{/if}}
    {{/ifeq}}

    {{#ifeq editor.field "source"}}
        {{#if visible}}
            {{!<error id="*EP_SOURCE_ABSENT" text#="$=editor.Title не указан">}}
            {{formEdit title=editor.title comment=editor.comment value=postingForm.source name="source" size="52"
                       maxlength="250" mandatory=editor.mandatory xmlid=xmlid}}
        {{else}}
            {{hidden name="source" value=postingForm.source}}
        {{/if}}
    {{/ifeq}}

    {{#ifeq editor.field "comment0"}}
        {{#if visible}}
            {{formEdit title=editor.title comment=editor.comment value=postingForm.comment0 name="comment0" size="52"
                       maxlength="250" mandatory=editor.mandatory xmlid=xmlid}}
        {{else}}
            {{hidden name="comment0" value=postingForm.comment0}}
        {{/if}}
    {{/ifeq}}

    {{#ifeq editor.field "body"}}
        {{#if visible}}
            {{formEditor title=editor.title comment=editor.comment name="body" body=postingForm.body rows="9"
                         mandatory=editor.mandatory xmlid=xmlid}}
        {{else}}
            {{hidden name="body" value=postingForm.body}}
        {{/if}}
    {{/ifeq}}

    {{#ifeq editor.field "body_format"}}
        {{#if visible}}
            {{> formTextFormat title=editor.title comment=editor.comment name="bodyFormat"
                                 format=postingForm.bodyFormat mandatory=editor.mandatory}}
        {{else}}
            {{hidden name="bodyFormat" value=postingForm.bodyFormat}}
        {{/if}}
    {{/ifeq}}

    {{#ifeq editor.field "index1"}}
        {{#if visible}}
            {{!<error id='*EP_INDEX1_ABSENT' text#='$=editor.Title не указан'>}}
            {{formEdit title=editor.title comment=editor.comment value=postingForm.index1 name="index1" size="3"
                       maxlength="5" mandatory=editor.mandatory}}
        {{else}}
            {{hidden name="index1" value=postingForm.index1}}
        {{/if}}
    {{/ifeq}}

    {{#ifeq editor.field "index2"}}
        {{#if visible}}
            {{#ifeq editor.style "issue-length"}}
                {{#formSelect title=editor.title comment=editor.comment name="index2" mandatory=editor.mandatory}}
                    {{formOption title="Обычный номер" value=0 selectedValue=postingForm.index2}}
                    {{formOption title="Сдвоенный номер" value=1 selectedValue=postingForm.index2}}
                    {{formOption title="Строенный номер" value=2 selectedValue=postingForm.index2}}
                    {{formOption title="Счетверенный номер" value=3 selectedValue=postingForm.index2}}
                {{/formSelect}}
            {{else}}
                {{formEdit title=editor.title comment=editor.comment value=postingForm.index2 name="index2" size="3"
                           maxlength="5" mandatory=editor.mandatory}}
            {{/ifeq}}
        {{else}}
            {{hidden name="index2" value=postingForm.index2}}
        {{/if}}
    {{/ifeq}}

    {{#ifeq editor.field "lang"}}
        {{#if visible}}
            {{#formSelect title=editor.title comment=editor.comment name="lang" mandatory=editor.mandatory}}
                {{formOption title=(safe "&mdash; Неизвестен &mdash;") value="" selectedValue=postingForm.lang}}
                {{#each const.langs}}
                    {{formOption title=title value=value selectedValue=postingForm.lang}}
                {{/each}}
            {{/formSelect}}
        {{else}}
            {{hidden name="lang" value=postingForm.lang}}
        {{/if}}
    {{/ifeq}}

    {{#ifeq editor.field "url"}}
        {{#if visible}}
            {{!<error id='*EP_URL_ABSENT' text#='$=editor.Title не указана'>}}
            {{formEdit title=editor.title comment=editor.comment value=postingForm.url name="url" size="52"
                       maxlength="250" mandatory=editor.mandatory}}
        {{else}}
            {{hidden name="url" value=postingForm.url}}
        {{/if}}
    {{/ifeq}}

    {{#ifeq editor.field "image"}}
        {{#if visible}}
            {{!  <error id='*EP_IMAGE_ABSENT' text#='Нужно указать $editor.WhatSV'>
              <error id='*EIU_UNKNOWN_IMAGE'
                     text#='Неизвестный формат $editor.WhatSR. Сайт понимает
                            $editor.WhatSVs только в форматах JPEG, PNG и GIF'>
              <error id='*EIU_IMAGE_LARGE'
                     text#='$editor.WhatLI слишком велика (больше 2M)'>
              <error id='*EIU_THUMBNAIL_LARGE'
                     text#='Маленькая $editor.WhatSI слишком велика (больше 2M)'>
              <error id='*EIU_UNKNOWN_THUMBNAIL'
                     text#='Формат маленькой $editor.WhatSR, указанный при конфигурации
                            сервера, не поддерживается, либо вы загрузили $editor.WhatSV
                            не этого формата'>
              <error id='*EIU_INTERNAL_ERROR' text#='Не удалось загрузить $editor.WhatSV'>
              <error id='*EP_LARGE_IMAGE_EXACT'
                     text#='$editor.WhatLI должна быть размером
                            ${editor.ImageExactX}x$editor.ImageExactY'>
              <error id='*EP_LARGE_IMAGE_EXACT_X'
                     text#='$editor.WhatLI должна быть шириной $editor.ImageExactX пикселов'>
              <error id='*EP_LARGE_IMAGE_EXACT_Y'
                     text#='$editor.WhatLI должна быть высотой $editor.ImageExactY пикселов'>
              <error id='*EP_SMALL_IMAGE_EXACT'
                     text#='Уменьшенная $editor.WhatSI должна быть размером
                            ${editor.ThumbExactX}x$editor.ThumbExactY'>
              <error id='*EP_SMALL_IMAGE_EXACT_X'
                     text#='Уменьшенная $editor.WhatSI должна быть шириной
                            $editor.ThumbExactX пикселов'>
              <error id='*EP_SMALL_IMAGE_EXACT_Y'
                     text#='Уменьшенная $editor.WhatSI должна быть высотой
                            $editor.ThumbExactY пикселов'>
              <error id='*EP_LARGE_IMAGE_MAX'
                     text#='$editor.WhatLI должна быть размером не более
                            ${editor.ImageMaxX}x$editor.ImageMaxY'>
              <error id='*EP_LARGE_IMAGE_MAX_X'
                     text#='$editor.WhatLI должна быть шириной не более $editor.ImageMaxX
                            пикселов'>
              <error id='*EP_LARGE_IMAGE_MAX_Y'
                     text#='$editor.WhatLI должна быть высотой не более $editor.ImageMaxY
                            пикселов'>
              <error id='*EP_SMALL_IMAGE_MAX'
                     text#='Уменьшенная $editor.WhatSI должна быть размером не более
                            ${editor.ThumbMaxX}x$editor.ThumbMaxY'>
              <error id='*EP_SMALL_IMAGE_MAX_X'
                     text#='Уменьшенная $editor.WhatSI должна быть шириной не более
                            $editor.ThumbMaxX пикселов'>
              <error id='*EP_SMALL_IMAGE_MAX_Y'
                     text#='Уменьшенная $editor.WhatSI должна быть высотой не более
                            $editor.ThumbMaxY пикселов'>}}
            <if what='$posting.hasSmallImage'>
                {{! FIXME: Vulnerability}}
                <hidden name='small_image' value='$posting.SmallImage'>
                <hidden name='small_image_x' value='$posting.SmallImageX'>
                <hidden name='small_image_y' value='$posting.SmallImageY'>
                <hidden name='small_image_format' value='$posting.SmallImageFormat'>
                <hidden name='large_image' value='$posting.LargeImage'>
                <hidden name='large_image_x' value='$posting.LargeImageX'>
                <hidden name='large_image_y' value='$posting.LargeImageY'>
                <hidden name='large_image_size' value='$posting.LargeImageSize'>
                <hidden name='large_image_format' value='$posting.LargeImageFormat'>
                <hidden name='large_image_filename' value='$posting.LargeImageFilename'>
                <assign name='loaded' value#='Загружен файл $=posting.LargeImageFilename
                                             (${posting.LargeImageX}x$posting.LargeImageY,
                                             ${posting.LargeImageSizeKB}K)'>
                <assign name='small_url' value!="$,hasLargeImage ? $,SmallImageURL : ''">
                <assign name='large_url' value="$,LargeImageURL">
            <else>
                <assign name='loaded' value=''>
                <assign name='small_url' value=''>
                <assign name='large_url' value=''>
            </if>
            <assign name='flags' value='$editor.ThumbnailStyle'>
            <if what="$flags!='manual' && $flags!='resize'">
                <form_uploader title='$=editor.Title' comment='$editor.Comment'
                               name='image_file' loaded='$loaded' delname='del_image'
                               small_url='$small_url' large_url='$large_url'
                               mandatory='$editor.isMandatory'>
            <else>
                <form_uploader title='$=editor.Title' comment='$editor.Comment'
                               name='image_file' small_name='image_file_thumb'
                               small_title='Маленькая:' large_title='Большая:'
                               loaded='$loaded' delname='del_image'
                               small_url='$small_url' large_url='$large_url'
                               mandatory='$editor.isMandatory'>
            </if>
        {{else}}
            {{! FIXME: Vulnerability}}
            <hidden name='small_image' value='$posting.SmallImage'>
            <hidden name='small_image_x' value='$posting.SmallImageX'>
            <hidden name='small_image_y' value='$posting.SmallImageY'>
            <hidden name='small_image_format' value='$posting.SmallImageFormat'>
            <hidden name='large_image' value='$posting.LargeImage'>
            <hidden name='large_image_x' value='$posting.LargeImageX'>
            <hidden name='large_image_y' value='$posting.LargeImageY'>
            <hidden name='large_image_size' value='$posting.LargeImageSize'>
            <hidden name='large_image_format' value='$posting.LargeImageFormat'>
            <hidden name='large_image_filename' value='$posting.LargeImageFilename'>
        {{/if}}
    {{/ifeq}}

    {{#ifeq editor.field "title"}}
        {{#if visible}}
            {{formEditor title=editor.title comment=editor.comment name="title" body=postingForm.title rows="3"
                         mandatory=editor.mandatory xmlid=xmlid}}
        {{else}}
            {{hidden name="title" value=postingForm.title}}
        {{/if}}
    {{/ifeq}}

    {{#ifeq editor.field "large_body"}}
        {{#if visible}}
            {{!<error id='*EP_LARGE_BODY_ABSENT' text#='$=editor.Title пуст'>}}
            {{formEditor title=editor.title comment=editor.comment name="largeBody" body=postingForm.largeBody rows="11"
                         mandatory=editor.mandatory xmlid=xmlid}}
        {{else}}
            {{hidden name="largeBody" value=postingForm.largeBody}}
        {{/if}}
    {{/ifeq}}

    {{#ifeq editor.field "large_body_format"}}
        {{#if visible}}
            {{> formTextFormat title=editor.title comment=editor.comment name="largeBodyFormat"
                                 format=postingForm.largeBodyFormat mandatory=editor.mandatory}}
        {{else}}
            {{hidden name="largeBodyFormat" value=postingForm.largeBodyFormat}}
        {{/if}}
    {{/ifeq}}

    {{#ifeq editor.field "sent"}}
        {{#if visible}}
            {{> formDateTime title=editor.title comment=editor.comment name="sent" date=postingForm.sentDate
                             time=postingForm.sentTime mandatory=editor.mandatory}}
        {{else}}
            {{hidden name="sentDate" value=postingForm.sentDate}}
            {{hidden name="sentTime" value=postingForm.sentTime}}
        {{/if}}
    {{/ifeq}}
{{/inline}}

{{> part/preamble}}
{{> part/top}}

{{#if postingForm.id}}
    {{#assign "formTitle"}}Редактирование {{postingForm.grpInfo.whatA}}{{/assign}}
{{else}}
    {{#assign "formTitle"}}Добавление {{postingForm.grpInfo.whatA}}{{/assign}}
{{/if}}
<form method="post" enctype="multipart/form-data" action="/actions/posting/modify">
    {{#formTable title=formTitle}}
        {{formErrors object=postingForm.grpInfo.fieldEditors}}
        {{hidden name="back" value=rc.back}}
        {{hidden name="origin" value=rc.location}}
        {{hidden name="full" value=postingForm.full}}
        {{hidden name="id" value=postingForm.id}}
        {{hidden name="personId" value=postingForm.personId}}
        {{hidden name="upId" value=postingForm.upId}}
        {{starInfo}}
   {{!
   <error id='*EP_NO_PERSON'
	  text='У этого пользователя нет персональной страницы'>
   <error id='*EP_TOPIC_ABSENT' text='Тема должна быть выбрана'>
   <error id='*EP_TOPIC_ACCESS'
	  text='Вы не имеете права добавлять сообщения по этой теме'>
   <error id='*EVH_NO_PARENT' text='Такой темы не существует'>
   <error id='*EVH_NO_UP' text='Вышестоящего сообщения не существует'>
   <error id='*EVH_LOOP' text='Сообщение не может быть подчиненным себе'>
   <error id='*EVH_NOT_UP_UNDER_PARENT'
          text='Тема вышестоящего сообщения должна совпадать с этой темой'>
   <error id='*EVH_INCORRECT' text='Нарушение иерархии объектов'>
   <error id='*EP_UP_APPEND'
	  text='Вы не имеете права присоединять сообщения к этому сообщению'>
   <error id='*EL_INVALID' text='Неверный ник или пароль'>
   <error id='*EL_GUEST_LOGIN_ABSENT' text='Укажите, пожалуйста, ваше имя'>}}
        {{#moderator}}
            {{#formComment}}<table><tr>
                {{#if postingForm.full}}
                    <td>{{image "/pics/down.gif"}}</td>
                    <td>&nbsp;<a href="?full=0">Скрыть все неиспользуемые поля</a></td>
                {{else}}
                    <td>{{image "/pics/right.gif"}}</td>
                    <td>&nbsp;<a href="?full=1">Показать все поля</a></td>
                {{/if}}
            </tr></table>{{/formComment}}
        {{/moderator}}
        {{#unless postingForm.id}}
            <form_relogin noguests='$noguests' relogin='$relogin'
                          login!='$edittag ? $login : $$userLoginHint'
                          remember='$remember' onclick='reloginSelected(this);'>
            <error id='*EP_CAPTCHA_ABSENT'
                   text='Пожалуйста, введите цифры и буквы, которые вы видите на
                         картинке. Это необходимо нам для борьбы со спамом.'>
            <error id='*EP_CAPTCHA' text='Неверные цифры и буквы, попробуйте еще раз'>
            <form_captcha id='captcha' name='captcha'>
        {{/unless}}
        {{#if postingForm.full}}
            {{formGrpSelect title="Группа" mandatory=true name="grp" value=postingForm.grp}}
        {{else}}
            {{hidden name="grp" value=postingForm.grp}}
        {{/if}}
        {{#unless postingForm.full}}
            {{#each postingForm.grpInfo.editors}}
                {{> editorLine editor=this visible=true}}
            {{/each}}
            {{#each postingForm.grpInfo.hiddenEditors}}
                {{> editorLine editor=this visible=false}}
            {{/each}}
        {{else}}
            {{#each grpNone.editors}}
                {{> editorLine editor=this visible=true}}
            {{/each}}
        {{/unless}}
        {{#moderator}}
            {{#assign "hiddenTitle"}}Сообщение видно только автору и модераторам{{/assign}}
        {{else}}
            {{#assign "hiddenTitle"}}Сообщение видно только мне и модераторам{{/assign}}
        {{/moderator}}
        {{#logged}}
            {{#formSelect title="Видимость" name="hidden" style="box"}}
                {{formOption title="Сообщение видно всем пользователям" value="0" selected=(not postingForm.hidden)}}
                {{formOption title=hiddenTitle value="1" selected=postingForm.hidden}}
            {{/formSelect}}
        {{else}}
            {{hidden name="hidden" value="0"}}
        {{/logged}}
        {{#moderator}}
            {{#assign "disabledTitle"}}Разрешено показывать только автору и модераторам{{/assign}}
        {{else}}
            {{#assign "disabledTitle"}}Разрешено показывать только мне и модераторам{{/assign}}
        {{/moderator}}
        {{#if postingForm.full}}
            {{#formSelect title="Запретить показ"
                          comment="Модераторский запрет на показ сообщения. Пользователь не может снять этот запрет."
                          name="disabled" style="box"}}
                {{formOption title="Нет запрета на показ всем пользователям" value="0" selected=(not postingForm.disabled)}}
                {{formOption title=disabledTitle value="1" selected=postingForm.disabled}}
            {{/formSelect}}
        {{else}}
            {{hidden name="disabled" value=postingForm.disabled}}
        {{/if}}
        {{#if postingForm.id}}
            {{formButtons title="Изменить"}}
        {{else}}
            {{formButtons title="Добавить"}}
        {{/if}}
    {{/formTable}}
</form>

{{> part/bottom}}