<< @(#) $Id$ >>

<element name='batcher' params='&list,topic_id,noedit'>
<table width=100%>
 <tr valign=bottom>
  <if what='!$noedit'>
   <td align=left class='info'>
    <table><tr valign=center>
     <td><image src='pics/sheet.gif'></td>
     <td>
      <if what='$topic_id<=0'>
       <assign name='topic_id' value='$`general`'>
      </if>
      <a href='postingedit.php?topic_id=$topic_id&grp=*GRP_GALLERY&noguests=1&redirid=$_'
	 >Добавить картинку</a>
     </td>
    </tr></table>
   </td>
  </if>
  <td align=center><spin list='$list'></td>
 </tr>
</table>
</element>

<element name='announce' params='posting,count'>
<table class='posting' width=100%>
 <tr valign=top>
  <td align=center width='$$thumbnailWidth' class='pic'>
   <ifnzero what='$posting.ImageSet'>
    <image_linked_tag id='$posting.ImageId' enlarge='$posting.hasLargeImage'>
   </ifnzero>
  </td>
  <td width=10>&nbsp;</td>
  <td align=left>
   <p class='subject'>
    <topiclink_gallery posting='$posting'>
   </p>
   <p>
    <biff time='$posting.Sent'>
    <array vals='0,1,2'>
    <plural value='$count'>
    <if what='$,==0'>
     Добавлена <a href='$posting.GalleryHref'>$count новая картинка</a>.
    <elif what='$,==1'>
     Добавлены <a href='$posting.GalleryHref'>$count новые картинки</a>.
    <else>
     Добавлены <a href='$posting.GalleryHref'>$count новых картинок</a>.
    </if>
   </p>
   <p class='sent'>
    <sentview date='$posting.Sent'><br>
    <senderlink message='$posting'>
   </p>
  </td>
 </tr>
 <tr><td colspan=3>
  <table width=100% class='bottom'><tr><td>&nbsp;</td></tr></table>
 </td></tr>
</table>
</element>

<element name='gallery_main'>
<if what='$topic_id>0'>
 <topic_allow id='$topic_id'>
 <assign name='noedit' value!='($, & *GRP_GALLERY)==0'>
<else>
 <assign name='noedit' value='*false'>
</if>
<iterate_postinglist grp='*GRP_GRAPHICS' topic_id='$topic_id' limit=40
                     offset='$offset' recursive='*true'
		     fields!='*SELECT_TOPICS|*SELECT_IMAGES'>
<batcher list='$;' topic_id='$topic_id' noedit='$noedit'>
<assign name='count' value=0>
<assign name='topic_id' value=0>
<assign name='user_id' value=0>
<assign name='sent' value=0>
<array name='postings'>
<for>
 <if what='$topic_id!=$.TopicId || $user_id!=$.UserId ||
           ($sent-$.Sent)/3600>$$userBiffTime'>
  <ifnzero what='$topic_id'>
   <array_random array='$postings'>
   <announce posting='$,' count='$count'>
  </ifnzero>
  <assign name='count' value=1>
  <assign name='topic_id' value='$.TopicId'>
  <assign name='user_id' value='$.UserId'>
  <array name='postings' val1='$.'>
 <else>
  <assign name='count' value!='$count+1'>
  <array_push array='$postings' value='$.'>
 </if>
 <assign name='sent' value='$.Sent'>
</for>
<ifnzero what='$topic_id'>
 <array_random array='$postings'>
 <announce posting='$,' count='$count'>
</ifnzero>
<ifnzero what='$;Count'>
 <batcher list='$;' topic_id='$topic_id' noedit='$noedit'>
</ifnzero>
</element>
