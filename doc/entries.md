Единая таблица entries
======================

В новых версиях ядра таблицы `complains`, `forums`, `images`, `messages`,
`postings`, `stotexts` и `topics` заменяются одной таблицей `entries`. Это
делается для упрощения запросов к БД и увеличения скорости работы. Все ссылки
на идентификаторы в вышеперечисленных таблицах заменяются на идентификаторы в
таблице `entries`. Это влечет за собой также и переименование некоторых таблиц
и полей в БД и переменных, функций и классов в программе. Требуется также
создание таблицы преобразования старых идентификаторов в новые.

Этот документ определяет использование полей обобщенной таблицы различными
типами `entries`.

С 1.12.2013 жалобы (элементы таблицы типа `EntryType.COMPLAIN`) были
упразднены.

На данный момент определены следующие типы entries:

  0 - временно удаленная запись (`EntryType.NULL`)
  1 - постинг (`EntryType.POSTING`)
  2 - комментарий (`EntryType.COMMENT`)
  3 - топик (`EntryType.TOPIC`)
  4 - картинка (относится только к картинкам в статье, не являющимся
      отдельными постингами) (`EntryType.IMAGE`)
  5 - не используется (ранее `EntryType.COMPLAIN`)
  6 - старая версия другой записи (`EntryType.VERSION`)

При переписывании ядра на Java механизм теней был упразднен. Тени были
превращены в ссылки на оригинальный постинг. Адрес ссылки не хранится, а
генерируется ядром, хранится только идентификатор оригинала. Соответственно,
часть полей оригинала были скопированы в тень.

Поля таблицы и их использование:

`id`<br>
Идентификатор.

`ident`<br>
Символьный идентификатор. Уникален. Установлен в NULL там, где отсутствует.
Пустая строка недопустима. Для обеспечения уникальности образует иерархию по
типу файловой системы с разделителем '.' (начальный и конечный не
указываются). Для того, чтобы идентификаторы постингов и топиков не совпали
при миграции, перед существующими идентификаторами постингов ставится `post.`.
Подробнее читай `doc/ident.md`.<br>
**Постинг:** используется как старое поле `postings.ident`.<br>
**Топик:** используется как старое поле `topics.ident`.<br>

`entry`<br>
Тип записи (см. выше).

`up`<br>
`track`<br>
Образуют иерархическую структуру с произвольным количеством корней. `up` -
ссылка наверх, `track` - полный путь к корню. Поле `track` должно быть
заполнено всегда, даже если `up` не используется, поскольку оно должно быть
уникальным.

`catalog`<br>
Буквенный путь к корню. Используется для построения URL'ов. Представляет собой
`ident`, в котором точки заменены на слэши. Либо, если `ident` не определен, -
вышестоящий `catalog`, к которому приписан `id` текущей записи. Всегда
заканчивается на слэш и никогда не начинается со слэша.

В более сложных случаях отдельные топики могут отмечаться в `modbits` с тем,
чтобы `catalog` начинался с них или игнорировал их.

`parent_id`<br>
Идентификатор ближайшей вверх по иерархии записи другого типа.<br>
**Постинг:** указывает на топик.<br>
**Комментарий:** указывает на постинг.<br>
**Топик:** не используется.<br>
**Картинка:** не используется.

`orig_id`<br>
Идентификатор оригинала. Все записи, где `id != orig_id`, являются ссылками на
оригинальную запись. Все типы записей должны проставлять `orig_id = id`.<br>
**Постинг:** используется по назначению.<br>
**Комментарий:** не используется.<br>
**Топик:** не используется.<br>
**Картинка:** используется для совместимости.

`current_id`<br>
Идентификатор текущей версии (эта версия имеет подлинный тип, не
`EntryType.VERSION`).<br>
Используется только версиями.

`grp`<br>
Подтип записи. Если запись может иметь несколько подтипов одновременно,
они объединяются при помощи побитового OR.

Подтипы задаются в файле конфигурации `grps.yaml`. Информация из него доступна
через методы класса `GrpEnum`. Методы `getGrp*()` класса `Posting` выдают
информацию, связанную с подтипом, к которому принадлежит данный постинг.<br>
**Постинг:** используется как старое поле `postings.grp`.<br>
**Топик:** описывает подтипы, допустимые в данном топике.

`person_id`<br>
Идентификатор юзера, к которому относится запись (не владельца).<br>
**Постинг:** используется как старое поле `postings.personal_id` - для
создания личных блогов.

`guest_login`<br>
Ник анонимного юзера, которому принадлежит запись. Используется, если
`user_id = 0`.

`user_id`<br>
`group_id`<br>
`perms`<br>
Атрибуты безопасности. Некоторыми типами записей намеренно не используются
для ускорения работы и упрощения запросов.<br>
**Картинка:** не используется.<br>
**Версия:** не используется - вместо этого работают атрибуты безопасности
оригинала. Можно также дублировать их во всех версиях, аналогично тому, как
это делается для теней.

`disabled`<br>
Флаг премодерирования. Если установлен, отменяет все атрибуты безопасности,
относящиеся к публике.<br>
**Картинка:** не используется.<br>
**Топик:** не используется.

`subject`<br>
Тема.<br>
**Постинг:** используется как старое поле `messages.subject`.<br>
**Комментарий:** используется как старое поле `messages.subject`.<br>
**Топик:** используется как старое поле `topics.name`.<br>
**Картинка:** не используется.

`lang`<br>
`author`<br>
`author_xml`<br>
`source`<br>
`source_xml`<br>
Язык, автор и источник. Используются по ситуации.

`title`<br>
`title_xml`<br>
Подпись под картинкой.<br>
**Постинг:** используется как старое поле `images.title` для прикрепленной
картинки. Картинки, представляющие собой отдельные постинги, хранят подпись
именно здесь, чтобы без проблем вставлять/извлекать их из статьи.<br>
**Картинка:** используется как старое поле `images.title`.

`comment0`<br>
`comment0_xml`<br>
`comment1`<br>
`comment1_xml`<br>
Произвольные текстовые описания. Могут задействоваться по мере надобности.
Подробнее читай в `doc/indexes.md`.

`url`<br>
`url_domain`<br>
`url_check`<br>
`url_check_success`<br>
Атрибуты хранения и проверки URL'ов.

`body`<br>
`body_xml`<br>
`body_format`<br>
`has_large_body`<br>
`large_body`<br>
`large_body_xml`<br>
`large_body_format`<br>
Тело сообщения - сокращенное и полное. `*_xml` - преобразованное в XML-формат,
позволяющий быстро выдавать HTML для отображения. Все поля, позволяющие
включать форматирование, должны иметь соответствующий `*_xml`. `*_format` -
исходный формат.

`priority`<br>
Приоритет записи. Не имеет четко очерченного значения.<br>
**Постинг:** используется как старое поле `postings.priority`.

`index0`<br>
`index1`<br>
`index2`<br>
Поля для сортировки и произвольных числовых отметок. `index0` используется
везде, где используется иерархия, для упорядочения записей на одном уровне
иерархии. Подробнее читай в `doc/indexes.md`.<br>
**Топик:** `index2` используется как старое поле `topics.index4`.

`set0`<br>
`set0_index`<br>
`set1`<br>
`set1_index`<br>
Множества, в которые входит эта запись, и ее порядковый номер в этом
множестве. Используется произвольно.

`vote`<br>
`vote_count`<br>
`rating`<br>
Информация о голосовании. Аналогично старым полям в `postings`, но, в
принципе, имеет смысл везде. `rating` - это кэшированная информация о
рейтинге, высчитанная из `vote`, `vote_count` и, может быть, каких-то других
характеристик. Алгоритм подсчета зависит от типа голосования - см. класс
`VoteType`.

`sent`<br>
Дата/время записи, предназначенные для отображения. Это поле может
модифицироваться пользователем и представляет собой дату, например,
описываемого события, которая может отличаться от даты создания записи.<br>
**Постинг:** используется как старое поле `messages.sent`.<br>
**Комментарий:** используется как старое поле `messages.sent`.<br>
**Топик:** инициализируется в текущее время.<br>
**Картинка:** не используется.

`created`<br>
`modified`<br>
`accessed`<br>
Дата/время создания, модификации и прочтения записи соответственно. Если эти
поля данным типом entry используются, но аналога им в старой структуре БД не
было, они инициализируются в текущее время.<br>
**Постинг:** `created` инициализируется из старого поля `messages.sent`,
`modified` используется как старое поле `messages.last_updated`, `accessed` -
как старое поле `postings.last_read`.<br>
**Комментарий:** `created` инициализируется из старого поля `messages.sent`.
`accessed` не используется.<br>
**Топик:** `accessed` не используется.<br>
**Картинка:** `accessed` предназначено для реализации в будущем "своппинга"
картинок для экономии места на хостинге.<br>
**Версия:** `modified` означает дату/время, к которой относится эта версия.

`creator_id`<br>
`modifier_id`<br>
Идентификатор пользователя, создавшего и модифицировавшего запись
соответственно. Используется исключительно для отслеживания изменений, не
влияет на права доступа. Изначально устанавливается в `user_id`.<br>
Не используется картинками.

`modbits`<br>
Набор флажков произвольного назначения. Смотри классы, реализующие интерфейс
`Modbit`.<br>
**Постинг:** используется как старое поле `postings.modbits`.<br>
**Топик:** используется как объединение старых полей `topics.premoderate`,
`topics.moderate` и `topics.edit`.

`comments`<br>
`last_comment`<br>
`last_comment_id`<br>
`last_comment_user_id`<br>
`last_comment_guest_login`<br>
Кэшированная информация об ответах. Здесь указывается только информация об
ответах, открытых для публики. Информация о закрытых/замодерированных ответах
отныне не кэшируется и, по-возможности, не сообщается (ради ускорения работы).

`small_image`<br>
`small_image_x`<br>
`small_image_y`<br>
`small_image_format`<br>
`large_image`<br>
`large_image_x`<br>
`large_image_y`<br>
`large_image_size`<br>
`large_image_format`<br>
`large_image_filename`<br>
Характеристики прикрепленной картинки и ее уменьшенной копии. Формат
уменьшенной копии стандартизирован для всех записей. Картинки, прикрепленные к
постингам и т.п. отныне хранятся в отдельном каталоге файловой системы, а не в
таблице `images`. В `small_image` и `large_image` хранятся номера картинок и
номера эти должны меняться при смене картинки, чтобы обойти кэширование. NULL
означает отсутствие картинки. Если уменьшение картинки не требуется,
`small_image` и `large_image` устанавливаются в одно и то же значение (для
упрощения логики). Картинки, вставленные в статью, представляются отдельными
записями, находящимися вниз по иерархии относительно статьи.

`counter0`<br>
`counter1`<br>
`counter2`<br>
`counter3`<br>
`ratio`<br>
Поля для произвольных счетчиков. Подробнее читай в `doc/indexes.md`.
