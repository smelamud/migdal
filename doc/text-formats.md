Форматы текстов
===============

Ядро различает 4 основных формата текстов:

1. Входной - тот, в котором пользователь ввел информацию.
2. Внутренний - в котором этот текст хранится в БД.
3. mtext - XML-формат, полуподготовленный для вывода, для более легкой
   конвертации в HTML, нежели внутренний. Используется при необходимости.
4. Выходной (HTML) - тот, в котором информация отдается пользователю.

Все тексты принимаются, хранятся и выдаются только в кодировке UTF-8.

Лигатуры
--------

Для ввода с клавиатуры таких символов как длинное тире, кавычки-"елочки", знак
номера и т.п., используются лигатуры, т.е. специальные последовательности
символов, которые преобразуются в один нужный.

Лигатуры:

<<  левая кавычка-"елочка"
>>  правая кавычка-"елочка"
--- длинное тире
``  левая кавычка-"лапка"
''  правая кавычка-"лапка"
(c) знак копирайта
(r) знак регистрации
(tm)    знак торговой марки
No. знак номера

Подстановка лигатур производится в момент передачи текста из объекта формы в
объект базы данных. Подстановку осуществляет метод `Text#convertLigatures()`.

Разметка текста
---------------

Пользователь может вводить текст в разных форматах. Им соотвествуют константы
в перечислении `TextFormat`.

**Простой** (`TextFormat.PLAIN`)

При отображении этого формата разрывы строк делаются там же, где они сделаны в
исходном тексте. Делаются также все замены, описанные в файле
`templates/help-text.hbs.html`.

Если в тексте используются тэги mtext, они попадают в сконвертированный mtext
в неизменном виде. Другие тэги экранируются и отображаются в виде обычного
текста.

**TeX-подобный** (`TextFormat.TEX`)

В этом формате переводы строки, сделанные в исходном тексте, игнорируются.
Если вы хотите разорвать строку в определенном месте, то в этом месте нужно
вставить два обратных слэша (\\).

Все замены в тексте делаются аналогично `TextFormat.PLAIN`.
  
**Mtext** (`TextFormat.XML`)

В этом формате, в отличие от остальных, не делаются никакие замены и
допускаются любые теги mtext. При этом абзацы по прежнему разделяются пустой
строкой и тег `<p>` использовать не нужно.

**Письмо** (`TextFormat.MAIL`)

Этот формат аналогичен `TextFormat.PLAIN`, но при его преобразовании строки,
начинающиеся с символов '>', считаются цитатой (как принято в письмах E-mail.

Преобразование пользовательского текста в mtext осуществляет метод
`Text.convert()`.

Mtext
-----

Mtext - это внутренний XML-формат, используемый для хранения текстов. Он имеет
три уровня, предназначенных для текстов разного размера (см. класс
`MtextFormat`).

Все тэги mtext перечислены в классе `MtextTags`. Кроме тэгов, аналогичных
тэгам HTML, в mtext добавлены несколько специфичных тэгов:

`<quote>...</quote>`<br>
Цитата из предыдущего комментария.

`<email addr="..." />`<br>
Вставка адреса e-mail.

`<user name="..." />`<br>
Вставка имени пользователя (аналогично `<lj name="...">` в LiveJournal).

`<footnote title="...">...</footnote>`<br>
Сноска.

`<incut align=... width=...>...</incut>`<br>
Врезка.

`<li title="...">...</li>`<br>
Элемент списка с заголовком.

Mtext хранится в полях `something_xml`. Кроме обычных методов
`getSomethingXml()`, в классе `Entry` есть также методы `getSomethingMtext()`,
возвращающие класс `Mtext`. Этот класс содержит все необходимое для
преобразования mtext в HTML.

Преобразование mtext в HTML осуществляют методы класса `MtextConverter`. Метод
`toHtml()` предназначен для обычных случаев. Именно его использует хелпер
`{{mtext}}`, принимающий в качестве аргумента объект `Mtext` и возвращающий
HTML. Метод `convert()`, возвращающий `MtextConverted` предназначен для текста
со сносками. Его использует хелпер `{{article}}`.
