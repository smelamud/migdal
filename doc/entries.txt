Единая таблица entries
======================

В новых версиях ядра таблицы complains, forums, images, messages, postings,
stotexts и topics заменяются одной таблицей entries. Это делается для
упрощения запросов к БД и увеличения скорости работы. Все ссылки на
идентификаторы в вышеперечисленных таблицах заменяются на идентификаторы в
таблице entries. Это влечет за собой также и переименование некоторых таблиц и
полей в БД и переменных, функций и классов в программе. Требуется также
создание таблицы преобразования старых идентификаторов в новые.

Этот документ определяет использование полей обобщенной таблицы различными
типами entries.

На данный момент определены следующие типы entries:

  0 - временно удаленная запись (ENT_NULL)
  1 - постинг (ENT_POSTING)
  2 - форум (ENT_FORUM)
  3 - топик (ENT_TOPIC)
  4 - картинка (относится только к картинкам в статье, не являющимся
      отдельными постингами) (ENT_IMAGE)
  5 - жалоба (ENT_COMPLAIN)
  6 - старая версия другой записи (ENT_VERSION)

При работе с тенями поля делятся на 3 группы:

  S - значение этого поля у каждой тени свое
  D - значение этого поля дублируется во всех тенях для ускорения поиска
  O - значение этого поля берется из оригинала для экономии места

Поля таблицы и их использование:

id		[S]
  Идентификатор.
ident		[S]
  Символьный идентификатор. Уникален. Установлен в NULL там, где отсутствует
  (в запросах используется coalesce(), чтобы не вносить путаницу
  NULL-значениями). Пустая строка недопустима. Для обеспечения уникальности
  образует иерархию по типу файловой системы с разделителем '.' (начальный и
  конечный не указываются). Для того, чтобы идентификаторы постингов и топиков
  не совпали при миграции, перед существующими идентификаторами постингов
  ставится 'post.'. Подробнее читай doc/ident.txt.
  Постинг: используется как старое поле postings.ident.
  Топик: используется как старое поле topics.ident.
entry		[D]
  Тип записи (см. выше).
up		[S]
track		[S]
  Образуют иерархическую структуру с произвольным количеством корней. up -
  ссылка наверх, track - полный путь к корню.
catalog		[S]
  Буквенный путь к корню. Используется для построения URL'ов. Представляет
  собой ident, в котором точки заменены на слэши. Либо, если ident не
  определен, - вышестоящий catalog, к которому приписан id. Всегда
  заканчивается на слэш и никогда не начинается со слэша.
parent_id	[S]
  Идентификатор ближайшей вверх по иерархии записи другого типа.
  Постинг: указывает на топик.
  Форум: указывает на постинг или жалобу.
  Топик: не используется.
  Картинка: не используется.
  Жалоба: не используется.
orig_id		[D]
  Идентификатор оригинала. Все записи, где id!=orig_id, являются тенями
  оригинальной записи.
  Используется только постингами.
current_id	[O]
  Идентификатор текущей версии (эта версия имеет подлинный тип, не
  ENT_VERSION). Используется только версиями.
grp		[S]
  Подтип записи. Если запись может иметь несколько подтипов одновременно,
  используется таблица entry_grps, которая привязывает несколько grp к одному
  entry_id.
  Постинг: используется как старое поле postings.grp.
  Топик: entry_grps используется как старое поле topics.allow, разложенное на
    составляющие.
  Жалоба: используется как старое поле complains.type_id.
link		[O]
  Идентификатор связи. Предназначен для хранения идентификатора какой-либо
  записи в какой-либо таблице.
  Жалоба: используется как старое поле complains.link.
person_id	[D]
  Идентификатор юзера, к которому относится запись (не владельца).
  Постинг: используется как старое поле postings.personal_id - для создания
    личных блогов.
  Жалоба: используется как старое поле complains.recipient_id - идентификатор
    юзера, отвечающего за отработку жалобы.
user_id		[D]
group_id	[D]
perms		[D]
  Атрибуты безопасности. Некоторыми типами записей намеренно не используются
  для ускорения работы и упрощения запросов. В случае наличия нескольких
  теней, эти атрибуты у них должны совпадать - это упрощает последующие
  выборки.
  Картинка: не используется.
  Жалоба: не используется для контроля прав - только для определения автора
    жалобы.
  Версия: не используется - вместо этого работают атрибуты безопасности
    оригинала. Можно также дублировать их во всех версиях, аналогично тому,
    как это делается для теней.
disabled	[D]
  Флаг премодерирования. Если установлен, отменяет все атрибуты безопасности,
  относящиеся к публике.
  Картинка: не используется.
  Топик: не используется.
  Жалоба: не используется.
subject		[O]
subject_sort	[D]
  Тема и информация для сортировки тем по алфавиту.
  Постинг: используется как старое поле messages.subject.
  Форум: используется как старое поле messages.subject.
  Топик: используется как старое поле topics.name.
  Картинка: не используется.
  Жалоба: используется как старое поле messages.subject.
lang		[D]
author		[O]
author_xml	[O]
source		[O]
source_xml	[O]
  Язык, автор и источник. Используются по ситуации.
title		[O]
title_xml	[O]
  Подпись под картинкой.
  Постинг: используется как старое поле images.title для прикрепленной
    картинки. Картинки, представляющие собой отдельные постинги, хранят подпись
    именно здесь, чтобы без проблем вставлять/извлекать их из статьи.
  Картинка: используется как старое поле images.title.
comment0	[O]
comment0_xml	[O]
comment1	[O]
comment1_xml	[O]
  Произвольные текстовые описания. Могут задействоваться по мере надобности.
url		[O]
url_domain	[O]
url_check	[O]
url_check_success	[O]
  Атрибуты хранения и проверки URL'ов.
body		[O]
body_xml	[O]
body_format	[O]
has_large_body	[O]
large_body	[O]
large_body_xml	[O]
large_body_format	[O]
large_body_filename	[O]
  Тело сообщения - сокращенное и полное. *_xml - преобразованное в
  XML-формат, позволяющий быстро выдавать для отображения. Все поля,
  позволяющие включать форматирование, должны иметь соответствующий *_xml.
  *_format - исходный формат. body_format используется для кодирования всех
  полей, где нет отдельного поля, указывающего его конкретный формат.
priority	[D]
  Приоритет записи. Не имеет четко очерченного значения.
  Постинг: используется как старое поле postings.priority.
  Жалоба: может, в принципе, использоваться аналогично приоритету (severity)
    багрепорта.
index0		[S]
index1		[D]
index2		[D]
  Поля для сортировки и произвольных числовых отметок. index0 используется
  везде, где используется иерархия, для упорядочения записей на одном уровне
  иерархии.
  Топик: index2 используется как старое поле topics.index4.
set0		[D]
set0_index	[D]
set1		[D]
set1_index	[D]
  Множества, в которые входит эта запись, и ее порядковый номер в этом
  множестве. Используется произвольно.
vote		[D]
vote_count	[D]
rating		[D]
  Информация о голосовании. Аналогично старым полям в postings, но, в
  принципе, имеет смысл везде. rating - это кэшированная информация о
  рейтинге, высчитанная из vote, vote_count и, может быть, каких-то других
  характеристик.
tmpid		[O]
  Временный идентификатор записи. Должен быть уникальным и сбрасываться в NULL
  через некоторое время после создания записи. Генерируется при появлении
  формы и служит для распознавания повторных нажатий на кнопку "Добавить".
  Перед созданием новой записи должно проверяться наличие записи с тем же
  tmpid и, если таковая существует, создание заменяется модификацией.
sent		[D]
  Дата/время записи, предназначенные для отображения. Это поле может
  модифицироваться пользователем и представляет собой дату, например,
  описываемого события, которая может отличаться от даты создания записи.
  Постинг: используется как старое поле messages.sent.
  Форум: используется как старое поле messages.sent.
  Топик: инициализируется в текущее время.
  Картинка: не используется.
  Жалоба: используется как старое поле messages.sent.
created		[S]
modified	[S]
accessed	[D]
  Дата/время создания, модификации и прочтения записи соответственно. Если эти
  поля данным типом entry используются, но аналога им в старой структуре БД не
  было, они инициализируются в текущее время.
  Постинг: created инициализируется из старого поля messages.sent, modified
    используется как старое поле messages.last_updated, accessed - как старое
    поле postings.last_read.
  Форум: created инициализируется из старого поля messages.sent. accessed не
    используется.
  Топик: accessed не используется.
  Картинка: accessed предназначено для реализации в будущем "своппинга"
    картинок для экономии места на хостинге.
  Жалоба: accessed не используется.
  Версия: modified означает дату/время, к которой относится эта версия.
modbits		[S]
  Набор флажков произвольного назначения.
  Постинг: используется как старое поле postings.modbits.
  Топик: используется как объединение старых полей topics.premoderate,
    topics.moderate и topics.edit.
  Жалоба: используется как объединение старых полей complains.closed и
    complains.no_auto.
answers		[D]
last_answer	[D]
last_answer_id	[D]
last_answer_user_id	[D]
  Кэшированная информация об ответах. Здесь указывается только информация об
  ответах, открытых для публики. Информация о закрытых/замодерированных
  ответах отныне не кэшируется и, по-возможности, не сообщается (ради
  ускорения работы).
small_image	[O]
small_image_x	[O]
small_image_y	[O]
large_image	[O]
large_image_x	[O]
large_image_y	[O]
large_image_size	[O]
large_image_format	[O]
large_image_filename	[O]
  Характеристики прикрепленной картинки и ее уменьшенной копии. Формат
  уменьшенной копии стандартизирован для всех записей. Картинки, прикрепленные
  к постингам и т.п. отныне хранятся в отдельном каталоге, а не в таблице
  images. В small_image и large_image хранятся номера картинок и номера эти
  должны меняться при смене картинки, чтобы обойти кэширование. Номер, равный
  0, означает отсутствие картинки. Картинки, вставленные в статью,
  представляются отдельными записями, находящимися вниз по иерархии
  относительно статьи.
used		[S]
  Флажок, используемый при чистке таблицы.

@(#) $Id$
