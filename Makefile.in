# Makefile for Migdal kernel

# @(#) $Id$

all: crontab dbcreate.sql
	(cd $(uiName); $(MAKE) all)

crontab: Makefile conf/migdal.conf
	(\
	echo 'PATH=/usr/local/bin:/bin:/usr/bin';\
	echo;\
	echo '# m       h  dom mon dow command';\
	echo '  30      *   *   *   *  $(scriptsDir)/hourly -c $(siteDir)/conf/migdal.conf -L $(scriptsDir)';\
	echo '  0-50/10 *   *   *   *  $(scriptsDir)/mailrobot -c $(siteDir)/conf/migdal.conf -L $(scriptsDir)';\
	) > crontab

dbcreate.sql:
	cat migdal.db $(uiName)/migdal.db > dbcreate.sql

Makefile: Makefile.in conf/migdal.conf
	./confmake $^ > Makefile

dbinfo:
	mysqldump -u $(dbUser) --password=$(dbPassword) $(dbName) \
		--no-data > migdal.db
	mysqldump -u $(dbUser) --password=$(dbPassword) $(dbName) \
		complain_types complain_scripts mailing_types \
		--no-create-info >> migdal.db
	(cd $(uiName); $(MAKE) dbinfo)

pack: all
	tar zchf $(uiName).tar.gz --exclude 'CVS' --exclude '*.mhtml' \
		--exclude 'Makefile*' --exclude '_template*' \
		--exclude '.cvsignore' --exclude '.xvpics' $(uiName) scripts \
		crontab dbcreate.sql

clean:
	-rm $(OBJECTS) crontab dbcreate.sql
	(cd $(uiName); $(MAKE) clean)
