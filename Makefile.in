# Makefile for Migdal kernel

# @(#) $Id$

all: crontab php dbcreate.sql
	(cd actions; $(MAKE) all)
	(cd cgi-bin; $(MAKE) all)
	(cd conf; $(MAKE) all)
	(cd lib; $(MAKE) all)
	(cd scripts; $(MAKE) all)
	(cd sources; $(MAKE) all)
	(cd tools; $(MAKE) all)
	(cd $(uiName); $(MAKE) all)

crontab: Makefile conf/migdal.conf
	-mkdir -p $(builddir)
	(\
	echo 'PATH=/usr/local/bin:/bin:/usr/bin';\
	echo;\
	echo '# m       h  dom mon dow command';\
	echo '  0-59/$(chatTimeout)  *   *   *   *  $(homeDir)/php $(scriptsDir)/chat.php';\
	echo '  30      *   *   *   *  $(homeDir)/php $(scriptsDir)/hourly.php';\
	echo '  0-50/10 *   *   *   *  $(homeDir)/php $(scriptsDir)/mailrobot.php';\
	echo '  30      23  *   *   *  $(homeDir)/php $(scriptsDir)/daily.php';\
	echo '  30      3   *   *   *  $(homeDir)/php $(scriptsDir)/packbooks.php';\
	echo '  20      *   *   *   *  $(homeDir)/php $(scriptsDir)/urlcheck.php';\
	echo '# 0       2   *   *   *  $(homeDir)/php $(scriptsDir)/replicate.php some.host';\
	echo;\
	) > $(builddir)/crontab

php: Makefile conf/migdal.conf
	-mkdir -p $(builddir)
	(\
	echo '#!/bin/sh';\
	echo;\
	echo '$(phpCommand) -q -d include_path=.:..:$(siteDir) -d max_execution_time=36000 $$*';\
	) > $(builddir)/php
	chmod +x $(builddir)/php
	
dbcreate.sql: Makefile conf/migdal.conf
	-mkdir -p $(builddir)
	cat migdal.db $(uiName)/migdal.db > $(builddir)/dbcreate.sql
	(\
	if [ $(rebeLogin) ]; then \
	echo "insert into users(login,login_sort,password,birthday,\
	email_disabled,rebe,admin_users,admin_topics,admin_complain_answers,\
	moderator,judge,admin_domain,hidden) values($(rebeLogin),$(rebeLogin),\
	MD5($(rebePassword)),'1900-01-01',1,1,1,1,1,1,1,1,2);";\
	fi;\
	if [ $(shamesLogin) ]; then \
	echo "insert into users(login,login_sort,birthday,hide_email,\
	email_disabled,shames,hidden,no_login) values($(shamesLogin),\
	$(shamesLogin),'1900-01-01',1,1,1,2,1);";\
	fi;\
	if [ $(regularLogin) ]; then \
	echo "insert into users(login,login_sort,password,birthday) \
	values($(regularLogin),$(regularLogin),MD5($(regularPassword)),'1900-01-01');";\
	fi\
	) >> $(builddir)/dbcreate.sql

Makefile: Makefile.in conf/migdal.conf
	./confmake $^ $(builddir) > Makefile

dbinfo:
	mysqldump -u $(dbUser) --password=$(dbPassword) $(dbName) \
		--no-data -Q > migdal.db
	mysqldump -u $(dbUser) --password=$(dbPassword) $(dbName) \
		version --no-create-info -Q >> migdal.db
	(cd $(uiName); $(MAKE) dbinfo)

pack: all
	tar zchf build.tar.gz $(builddir)

clean:
	-rm -r $(builddir)
	(cd $(uiName); $(MAKE) clean)
