# Makefile for Migdal kernel

# @(#) $Id$

all: crontab php dbcreate.sql
	(cd $(uiName); $(MAKE) all)
	ln -snf $(uiName)/grp grp

crontab: Makefile conf/migdal.conf
	(\
	echo 'PATH=/usr/local/bin:/bin:/usr/bin';\
	echo;\
	echo '# m       h  dom mon dow command';\
	echo '  30      *   *   *   *  $(homeDir)/php $(scriptsDir)/hourly.php';\
	echo '  0-50/10 *   *   *   *  $(homeDir)/php $(scriptsDir)/mailrobot.php';\
	echo '  30      23  *   *   *  $(homeDir)/php $(scriptsDir)/daily.php';\
	echo '  10      22  *   *   *  $(homeDir)/php $(scriptsDir)/ratings.php';\
	echo '  20      *   *   *   *  $(homeDir)/php $(scriptsDir)/urlcheck.php';\
	echo;\
	) > crontab

php: Makefile conf/migdal.conf
	(\
	echo '#!/bin/sh';\
	echo;\
	echo '$(phpCommand) -q -d include_path=.:..:$(siteDir) -d max_execution_time=3600 $$*';\
	) > php
	chmod +x php
	
dbcreate.sql: Makefile conf/migdal.conf
	cat migdal.db $(uiName)/migdal.db > dbcreate.sql
	(\
	if [ $(rebeLogin) ]; then\
	echo "insert into users(login,login_sort,password,birthday,\
	email_disabled,rebe,admin_users,admin_topics,admin_complain_answers,\
	moderator,judge,admin_domain,hidden) values($(rebeLogin),$(rebeLogin),\
	MD5($(rebePassword)),'1900-01-01',1,1,1,1,1,1,1,1,2);";\
	fi;\
	if [ $(shamesLogin) ]; then\
	echo "insert into users(login,login_sort,birthday,hide_email,\
	email_disabled,shames,hidden,no_login) values($(shamesLogin),\
	$(shamesLogin),'1900-01-01',1,1,1,2,1);";\
	fi;\
	if [ $(regularLogin) ]; then\
	echo "insert into users(login,login_sort,password,birthday) \
	values($(regularLogin),$(regularLogin),MD5($(regularPassword)),'1900-01-01');";\
	fi\
	) >> dbcreate.sql

Makefile: Makefile.in conf/migdal.conf
	./confmake $^ > Makefile

dbinfo:
	mysqldump -u $(dbUser) --password=$(dbPassword) $(dbName) \
		--no-data > migdal.db
	mysqldump -u $(dbUser) --password=$(dbPassword) $(dbName) \
		version --no-create-info >> migdal.db
	(cd $(uiName); $(MAKE) dbinfo)

pack: all
	tar zchf $(uiName).tar.gz --exclude 'CVS' --exclude '*.mhtml' \
		--exclude '*.mcss' --exclude 'Makefile*' \
		--exclude '_template*' --exclude '.cvsignore' \
		--exclude '.xvpics' --exclude 'migdal.db' \
		--exclude 'groups.conf' $(uiName) scripts crontab \
		dbcreate.sql php

clean:
	-rm $(OBJECTS) crontab dbcreate.sql
	(cd $(uiName); $(MAKE) clean)
