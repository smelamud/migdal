# Makefile for Migdal kernel

# @(#) $Id$

all: crontab dbcreate.sql
	(cd $(uiName); $(MAKE) all)

crontab: Makefile conf/migdal.conf
	(\
	echo 'PATH=/usr/local/bin:/bin:/usr/bin';\
	echo;\
	echo '# m       h  dom mon dow command';\
	echo '  30      *   *   *   *  $(scriptsDir)/hourly -c $(siteDir)/conf/migdal.conf -L $(scriptsDir)';\
	echo '  0-50/10 *   *   *   *  $(scriptsDir)/mailrobot -c $(siteDir)/conf/migdal.conf -L $(scriptsDir)';\
	echo '  10      22  *   *   *  $(scriptsDir)/ratings -c $(siteDir)/conf/migdal.conf -L $(scriptsDir)';\
	) > crontab

dbcreate.sql: Makefile conf/migdal.conf
	cat migdal.db $(uiName)/migdal.db > dbcreate.sql
	(\
	if [ $(rebeLogin) ]; then\
	echo "insert into users(login,password,birthday,email_disabled,rebe,\
	admin_users,admin_topics,admin_menu,admin_complain_answers,moderator,\
	judge,hidden) values($(rebeLogin),MD5($(rebePassword)),\
	'1900-01-01',1,1,1,1,1,1,1,1,2);";\
	fi;\
	if [ $(shamesLogin) ]; then\
	echo "insert into users(login,birthday,hide_email,email_disabled,\
	shames,hidden,no_login) values($(shamesLogin),'1900-01-01',1,1,1,2,\
	1);";\
	fi;\
	if [ $(regularLogin) ]; then\
	echo "insert into users(login,password,birthday) \
	values($(regularLogin),MD5($(regularPassword)),'1900-01-01');";\
	fi\
	) >> dbcreate.sql

Makefile: Makefile.in conf/migdal.conf
	./confmake $^ > Makefile

dbinfo:
	mysqldump -u $(dbUser) --password=$(dbPassword) $(dbName) \
		--no-data > migdal.db
	mysqldump -u $(dbUser) --password=$(dbPassword) $(dbName) \
		complain_types complain_scripts mailing_types version \
		--no-create-info >> migdal.db
	(cd $(uiName); $(MAKE) dbinfo)

pack: all
	tar zchf $(uiName).tar.gz --exclude 'CVS' --exclude '*.mhtml' \
		--exclude '*.mcss' --exclude 'Makefile*' \
		--exclude '_template*' --exclude '.cvsignore' \
		--exclude '.xvpics' --exclude 'migdal.db' $(uiName) scripts \
		crontab dbcreate.sql

clean:
	-rm $(OBJECTS) crontab dbcreate.sql
	(cd $(uiName); $(MAKE) clean)
