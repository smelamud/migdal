Инструкции по установке
=======================

Системные требования
--------------------
			      
Для работы ядра Web-сайта "Migdal" требуется:

* Apache 1.3.19
* PHP 4.1.2
  * pcre 3.4
  * mysql
  * iconv
  * xml
  * Командно-строчный интерпретатор PHP (для запуска скриптов из cron'а)
* MySQL 3.23.32
* Perl 5.6.1 (для сборки)
* Wget 1.8.1 (для проверки URL'ов)

Для изменения размеров картинки можно использовать функцию ImageCopyResized из
GD>=1.6.2, но эта функция не использует интерполяцию, поэтому картинка
получается плохого качества. Поэтому рекомендуется GD>=2.0.1 (с функцией
ImageCopyResampled) или ImageMagick 5.3.9 (с программой mogrify). Не забудьте
установить соответствующие флаги в conf/migdal.conf.

Для ускорения работы с календарем рекомендуется скомпилировать PHP с модулем
calendar. Без этого модуля будет использована встроенная эмуляция.

Для автоматической генерации паролей понадобится любой генератор паролей (см.
флаги в conf/migdal.conf).

Сборка
------

Установка ядра "Migdal" состоит из двух этапов: сборки на локальной машине и
развертывания на Web-сервере.

Следующие действия выполняются на локальной машине:

Распакуйте архив с исходными текстами ядра:

local::~$ tar zxf migdal-xxxx.tar.gz

Скопируйте файл conf/migdal.conf.example в conf/migdal.conf и отредактируйте
conf/migdal.conf, если необходимо. Обратите внимание, что все пути, указываемые
в migdal.conf, относятся к Web-серверу, на котором сайт будет располагаться в
итоге, а не к каталогу на локальной машине, в котором в данный момент лежат
исходники.

Запустите скрипт ./configure:

local::~/migdal$ ./configure

Этот скрипт создаст Makefile, где необходимо.

И, наконец:

local::~/migdal$ make
local::~/migdal$ make pack

В результате вы получите архив build.tar.gz, содержащий все файлы, необходимые
для развертывания на Web-сервере.

Если вы захотите впоследствии изменить конфигурацию ядра, просто отредактируте
migdal.conf и перезапустите make и make pack.

Развертывание на Web-сервере
----------------------------

Скопируйте build.tar.gz на Web-сервер любым доступным Вам способом и
распакуйте его там (или залейте его сразу в распакованном виде, если у вас нет
shell-доступа к Web-серверу).

В каталоге .build/www/ находится сам сайт. Это и есть DocumentRoot вашего
сайта.  Если вы не можете изменить DocumentRoot, скопируйте содержимое
каталога .build/www/ в нужное место.

После этого можете проверить работоспособность Apache и PHP - утилиты в
каталоге tools/ уже должны быть доступны.

В каталоге scripts/ находятся исполняемые на Web-сервере скрипты на Perl.

Файл crontab - это файл конфигурации для демона cron. Если у вас нет доступа к
cron, то вам не будут доступны следующие возможности:

* Автоматическая чистка базы данных.
* Рассылка писем.
* Автоматическое закрытие жалоб.

Файл dbcreate.sql - это SQL-скрипт для создания таблиц и наполнения базы
данных. Сама база данных уже должна быть создана доступным вам способом.
Запустите скрипт:

server::~$ mysql -h <dbHost> -u <dbUser> -p <dbName> < dbcreate.sql

Или воспользуйтесь утилитой tools/sql.php, входящей в состав ядра, если у вас
нет shell-доступа к Web-серверу.

После этого сайт должен начать функционировать.

Предупреждение: Для нормальной работы ядра в конфигурации Apache должно быть
разрешено локальное изменение переменных PHP (см. AllowOverride).

Развертывание на локальной машине (для разработчиков)
-----------------------------------------------------

Если вы собираетесь модифицировать исходники ядра, то очень удобно установить
Apache и PHP на локальной машине и указать Apache в качестве DocumentRoot
каталог .build/www/. Тогда после выполнения make все сделанные вами изменения
сразу станут видны на Web-сервере.

База данных создается аналогично тому, как было показано для Web-сервера.

Предупреждение: Для нормальной работы ядра на локальной машине разработчика в
конфигурации Apache должно быть разрешено следование по симлинкам (см.
FollowSymLinks) и локальное изменение переменных PHP (см. AllowOverride).

Миграция со старых версий ядра
------------------------------

В связи с последними изменениями в ядре миграция с сохранением данных является
нетривиальной задачей. Поэтому все скрипты для обновления структуры базы данных
были убраны от греха подальше. Если вам необходимо обновить структуру БД,
обратитесь за инструкциями непосредственно к разработчику.

@(#) $Id$
